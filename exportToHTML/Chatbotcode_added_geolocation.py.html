<html>
<head>
<title>Chatbotcode_added_geolocation.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Chatbotcode_added_geolocation.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">flask </span><span class="s0">import </span><span class="s1">Flask</span><span class="s0">, </span><span class="s1">request</span><span class="s0">, </span><span class="s1">jsonify</span><span class="s0">, </span><span class="s1">render_template</span>
<span class="s0">import </span><span class="s1">requests</span>
<span class="s0">import </span><span class="s1">json</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">weo </span><span class="s0">import </span><span class="s1">download</span><span class="s0">, </span><span class="s1">WEO</span>
<span class="s0">import </span><span class="s1">numpy_financial </span><span class="s0">as </span><span class="s1">npf</span>
<span class="s0">from </span><span class="s1">geopy.geocoders </span><span class="s0">import </span><span class="s1">Nominatim</span>
<span class="s0">import </span><span class="s1">apicode</span>
<span class="s0">from </span><span class="s1">flask_cors </span><span class="s0">import </span><span class="s1">CORS</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">countryinfo </span><span class="s0">import </span><span class="s1">CountryInfo</span>



<span class="s1">app = Flask(</span><span class="s2">&quot;__name__&quot;</span><span class="s1">)</span>

<span class="s1">CORS(app)</span>
<span class="s1">dict1 = dict()</span>

<span class="s3">#Dictionary Inititialisations to avoid errors</span>
<span class="s1">dict1[</span><span class="s2">&quot;type&quot;</span><span class="s1">] = </span><span class="s2">&quot;&quot;</span>
<span class="s1">dict1[</span><span class="s2">&quot;RetrResp&quot;</span><span class="s1">] = </span><span class="s2">&quot;&quot;</span>
<span class="s1">dict1[</span><span class="s2">&quot;RetrAmt&quot;</span><span class="s1">]=</span><span class="s4">0</span>
<span class="s1">dict1[</span><span class="s2">&quot;Investments&quot;</span><span class="s1">]=</span><span class="s4">0</span>
<span class="s3">#Changes Made</span>
<span class="s0">def </span><span class="s1">sumInsured():</span>
    <span class="s3">#Calculating Inflation using WEO</span>
    <span class="s1">path</span><span class="s0">, </span><span class="s1">url = download(</span><span class="s4">2022</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">print(dict1[</span><span class="s2">&quot;country&quot;</span><span class="s1">])</span>
    <span class="s1">df_cpi_country = WEO(path).countries(dict1[</span><span class="s2">&quot;country&quot;</span><span class="s1">])[</span><span class="s2">&quot;ISO&quot;</span><span class="s1">]</span>
    <span class="s1">print(df_cpi_country)</span>
    <span class="s1">country_code = list(df_cpi_country)[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">df_cpi_inflation = WEO(path).inflation()[country_code][</span><span class="s2">&quot;2021&quot;</span><span class="s1">]</span>
    <span class="s1">inflation = df_cpi_inflation*</span><span class="s4">0.01</span>

    <span class="s3">#Sum Insured Calculation</span>
    <span class="s1">years = dict1[</span><span class="s2">&quot;RetrAge&quot;</span><span class="s1">] - dict1[</span><span class="s2">&quot;Age&quot;</span><span class="s1">]</span>
    <span class="s1">inv_rate = </span><span class="s4">0.10</span>
    <span class="s1">disc_rate = </span><span class="s4">0.10 </span><span class="s1">- inflation</span>
    <span class="s1">avg_expenses = dict1[</span><span class="s2">&quot;AvgExpenses&quot;</span><span class="s1">]*</span><span class="s4">12</span>
    <span class="s1">pmt = dict1[</span><span class="s2">&quot;Income&quot;</span><span class="s1">] - avg_expenses</span>
    <span class="s1">other_income = dict1[</span><span class="s2">&quot;Investments&quot;</span><span class="s1">] - dict1[</span><span class="s2">&quot;Loan&quot;</span><span class="s1">]</span>
    <span class="s1">pv = npf.pv(disc_rate</span><span class="s0">,</span><span class="s1">years</span><span class="s0">,</span><span class="s1">-avg_expenses</span><span class="s0">,</span><span class="s4">0</span><span class="s0">,</span><span class="s1">when=</span><span class="s2">'end'</span><span class="s1">)</span>
    <span class="s1">sum_insured = round(pv[</span><span class="s4">0</span><span class="s1">] - other_income</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">text1 = </span><span class="s2">&quot;Based on your details the right sum assured for you would be {} &quot;</span><span class="s1">.format(sum_insured)</span>
    <span class="s1">text2 = </span><span class="s2">&quot;Thank you for the details&quot;</span>
    <span class="s0">return </span><span class="s1">[text1</span><span class="s0">,</span><span class="s1">text2]</span>

<span class="s0">def </span><span class="s1">goalPlan(age</span><span class="s0">,</span><span class="s1">retrAge):</span>
    <span class="s1">diffAge = retrAge - age</span>
    <span class="s0">if </span><span class="s1">diffAge &gt;= </span><span class="s4">3 </span><span class="s1">:</span>
        <span class="s1">plan = </span><span class="s2">&quot;Deferred Plan&quot;</span>
    <span class="s0">else </span><span class="s1">:</span>
        <span class="s1">plan = </span><span class="s2">&quot;Immediate Plan&quot;</span>
    <span class="s1">dict1[</span><span class="s2">&quot;AnnuityPlan&quot;</span><span class="s1">] = plan</span>
    <span class="s1">text1 = </span><span class="s2">&quot;According to your response it would be preferrable to select {}&quot;</span><span class="s1">.format(plan)</span>
    <span class="s1">text2 = </span><span class="s2">&quot;Could you please confirm by selecting the preferred choice&quot;</span>
    <span class="s0">return </span><span class="s1">[text1</span><span class="s0">,</span><span class="s1">text2</span><span class="s0">,</span><span class="s1">[</span><span class="s2">&quot;Deferred Plan&quot;</span><span class="s0">,</span><span class="s2">&quot;Immediate Plan&quot;</span><span class="s1">]]</span>

<span class="s0">def </span><span class="s1">annCalculation():</span>
    <span class="s3">#Calculating Inflation using WEO</span>
    <span class="s1">path</span><span class="s0">, </span><span class="s1">url = download(</span><span class="s4">2022</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">print(dict1[</span><span class="s2">&quot;country&quot;</span><span class="s1">])</span>
    <span class="s1">df_cpi_country = WEO(path).countries(dict1[</span><span class="s2">&quot;country&quot;</span><span class="s1">])[</span><span class="s2">&quot;ISO&quot;</span><span class="s1">]</span>
    <span class="s1">print(df_cpi_country)</span>
    <span class="s1">country_code = list(df_cpi_country)[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">df_cpi_inflation = WEO(path).inflation()[country_code][</span><span class="s2">&quot;2021&quot;</span><span class="s1">]</span>
    <span class="s1">inflation = df_cpi_inflation*</span><span class="s4">0.01</span>

    <span class="s3">#Annuity Calculation</span>
    <span class="s1">n = dict1[</span><span class="s2">&quot;RetrAge&quot;</span><span class="s1">] - dict1[</span><span class="s2">&quot;Age&quot;</span><span class="s1">]</span>
    <span class="s1">roi = </span><span class="s4">0.09</span>
    <span class="s1">expenses = dict1[</span><span class="s2">&quot;AvgExpenses&quot;</span><span class="s1">]*</span><span class="s4">0.75</span>
    <span class="s1">fv_expenses = (expenses * pow((</span><span class="s4">1 </span><span class="s1">+ inflation)</span><span class="s0">, </span><span class="s1">n))</span>
    <span class="s1">retr_age = dict1[</span><span class="s2">&quot;RetrAge&quot;</span><span class="s1">]</span>
    <span class="s0">if </span><span class="s1">dict1[</span><span class="s2">&quot;Sex&quot;</span><span class="s1">] == </span><span class="s2">&quot;Male&quot;</span><span class="s1">:</span>
        <span class="s1">life_expectancy = </span><span class="s4">73</span>
    <span class="s0">elif </span><span class="s1">dict1[</span><span class="s2">&quot;Sex&quot;</span><span class="s1">] == </span><span class="s2">&quot;Female&quot;</span><span class="s1">:</span>
        <span class="s1">life_expectancy = </span><span class="s4">76</span>
    <span class="s1">arr = ((</span><span class="s4">1 </span><span class="s1">+ roi) / (</span><span class="s4">1 </span><span class="s1">+ inflation)) - </span><span class="s4">1</span>
    <span class="s1">arr_monthly = arr / </span><span class="s4">12</span>
    <span class="s1">retr_months = (life_expectancy - retr_age) * </span><span class="s4">12</span>
    <span class="s1">pmt = fv_expenses</span>
    <span class="s0">if </span><span class="s1">dict1[</span><span class="s2">&quot;RetrAmt&quot;</span><span class="s1">]&gt;</span><span class="s4">0</span><span class="s1">:</span>
        <span class="s1">corpus = npf.pv(arr_monthly</span><span class="s0">, </span><span class="s1">retr_months</span><span class="s0">, </span><span class="s1">-pmt</span><span class="s0">, </span><span class="s1">when=</span><span class="s2">'end'</span><span class="s1">)</span>
        <span class="s1">corpus= corpus[</span><span class="s4">0</span><span class="s1">] - dict1[</span><span class="s2">&quot;RetrAmt&quot;</span><span class="s1">]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">corpus = npf.pv(arr_monthly</span><span class="s0">, </span><span class="s1">retr_months</span><span class="s0">, </span><span class="s1">-pmt</span><span class="s0">, </span><span class="s1">when=</span><span class="s2">'end'</span><span class="s1">)</span>
        <span class="s1">corpus = corpus[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">print(corpus)</span>

    <span class="s0">if </span><span class="s1">dict1[</span><span class="s2">&quot;Investments&quot;</span><span class="s1">]&gt;</span><span class="s4">0</span><span class="s1">:</span>
        <span class="s1">corpus-=dict1[</span><span class="s2">&quot;Investments&quot;</span><span class="s1">]</span>
    <span class="s1">corpus =round (corpus</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">premium = npf.pmt(roi / </span><span class="s4">12</span><span class="s0">, </span><span class="s1">n * </span><span class="s4">12</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">-corpus</span><span class="s0">, </span><span class="s1">when=</span><span class="s2">'end'</span><span class="s1">)</span>
    <span class="s1">premium =round(premium</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">currencies = CountryInfo(dict1[</span><span class="s2">&quot;country&quot;</span><span class="s1">]).currencies()</span>
    <span class="s1">print(currencies[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">text1 = </span><span class="s2">&quot;According to your responses you would need approximately {} {} as retirement corpus&quot;</span><span class="s1">.format(corpus</span><span class="s0">,</span><span class="s1">currencies[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">text2 = </span><span class="s2">&quot;So if you invest {} {} monthly as part of Annuity Plan you would be able to secure your retirement&quot;</span><span class="s1">.format(premium</span><span class="s0">,</span><span class="s1">currencies[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s0">return </span><span class="s1">[text1</span><span class="s0">,</span><span class="s1">text2]</span>


<span class="s0">def </span><span class="s1">geoDetails(city):</span>
    <span class="s1">loc = Nominatim(user_agent=</span><span class="s2">&quot;GetLoc&quot;</span><span class="s1">)</span>
    <span class="s3"># entering the location name</span>
    <span class="s1">getLoc = loc.geocode(city)</span>
    <span class="s1">state = getLoc.address.split(</span><span class="s2">&quot;,&quot;</span><span class="s1">)[-</span><span class="s4">3</span><span class="s1">]</span>
    <span class="s1">country = getLoc.address.split(</span><span class="s2">&quot;,&quot;</span><span class="s1">)[-</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">dict1[</span><span class="s2">&quot;country&quot;</span><span class="s1">] = country.strip()</span>
    <span class="s1">api_key = </span><span class="s2">&quot;432e12f9-57c3-42c4-8fa1-ba346837d8a8&quot;</span>
    <span class="s1">response_api = requests.get(</span>
        <span class="s2">f'http://api.airvisual.com/v2/city?city=</span><span class="s0">{</span><span class="s1">city</span><span class="s0">}</span><span class="s2">&amp;state=</span><span class="s0">{</span><span class="s1">state</span><span class="s0">}</span><span class="s2">&amp;country=</span><span class="s0">{</span><span class="s1">country</span><span class="s0">}</span><span class="s2">&amp;key=</span><span class="s0">{</span><span class="s1">api_key</span><span class="s0">}</span><span class="s2">'</span><span class="s1">)</span>
    <span class="s1">data = response_api.text</span>
    <span class="s1">parse_json = json.loads(data)</span>
    <span class="s3"># print(parse_json)</span>
    <span class="s1">weather = parse_json[</span><span class="s2">'data'</span><span class="s1">][</span><span class="s2">'current'</span><span class="s1">][</span><span class="s2">'weather'</span><span class="s1">]</span>
    <span class="s1">temperature = weather[</span><span class="s2">'tp'</span><span class="s1">]</span>
    <span class="s1">aqius = parse_json[</span><span class="s2">'data'</span><span class="s1">][</span><span class="s2">'current'</span><span class="s1">][</span><span class="s2">'pollution'</span><span class="s1">][</span><span class="s2">'aqius'</span><span class="s1">]</span>
    <span class="s3">#print(temperature)</span>
    <span class="s0">if </span><span class="s1">temperature &gt; </span><span class="s4">35</span><span class="s1">:</span>
        <span class="s1">climate = </span><span class="s2">&quot;hot climate so be careful&quot;</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">climate = </span><span class="s2">&quot;better climate&quot;</span>
    <span class="s0">if </span><span class="s1">aqius &gt; </span><span class="s4">100</span><span class="s1">:</span>
        <span class="s1">pol = </span><span class="s2">&quot;high pollution levels&quot;</span>
        <span class="s1">pol1 = </span><span class="s2">&quot;dangerous so be careful when you step out&quot;</span>
    <span class="s0">elif </span><span class="s1">aqius &lt; </span><span class="s4">100 </span><span class="s0">and </span><span class="s1">aqius &gt; </span><span class="s4">50</span><span class="s1">:</span>
        <span class="s1">pol = </span><span class="s2">&quot;moderate pollution&quot;</span>
        <span class="s1">pol1 = </span><span class="s2">&quot;okay but take precautions while heading out&quot;</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">pol = </span><span class="s2">&quot;low pollution&quot;</span>
        <span class="s1">pol1 = </span><span class="s2">&quot;an excellent place to breathe safely&quot;</span>
    <span class="s3">#Changes Made</span>
    <span class="s3">#Expenses details</span>
    <span class="s1">file = </span><span class="s2">&quot;C:/Users/Gautam/Desktop/Numbeo.csv&quot;</span>
    <span class="s1">df = pd.read_csv(file)</span>
    <span class="s1">df_values = df.loc[df[</span><span class="s2">'City'</span><span class="s1">] == city][</span><span class="s2">&quot;Expenses3&quot;</span><span class="s1">]</span>
    <span class="s1">dict1[</span><span class="s2">&quot;AvgExpenses&quot;</span><span class="s1">] = df_values</span>

    
    <span class="s1">text1 = </span><span class="s2">&quot; {} has generally {}</span><span class="s0">\n </span><span class="s2">It has {} which is {} &quot;</span><span class="s1">.format(city</span><span class="s0">, </span><span class="s1">climate</span><span class="s0">, </span><span class="s1">pol</span><span class="s0">, </span><span class="s1">pol1)</span>
    <span class="s1">text2 = </span><span class="s2">&quot;What is your marital status ?&quot;</span>
    <span class="s1">chipslist = [</span><span class="s2">&quot;Single&quot;</span><span class="s0">,</span><span class="s2">&quot;Divorced&quot;</span><span class="s0">,</span><span class="s2">&quot;Married&quot;</span><span class="s1">]</span>
    <span class="s0">return </span><span class="s1">[text1</span><span class="s0">,</span><span class="s1">text2</span><span class="s0">, </span><span class="s1">chipslist]</span>
    <span class="s3"># response = {</span>
    <span class="s3">#     'fulfillmentMessages': [</span>
    <span class="s3">#         {</span>
    <span class="s3">#             &quot;text&quot;: {</span>
    <span class="s3">#                 &quot;text&quot;: [</span>
    <span class="s3">#                     &quot; {} has generally {}\n It has {} which is {} &quot;.format(city, climate, pol, pol1)</span>
    <span class="s3">#                 ],</span>

    <span class="s3">#             }</span>
    <span class="s3">#         },</span>
    <span class="s3">#         {</span>
    <span class="s3">#             &quot;text&quot;: {</span>
    <span class="s3">#                 &quot;text&quot;: [</span>
    <span class="s3">#                     &quot;When will be your happy retirement age?&quot;</span>
    <span class="s3">#                 ]</span>
    <span class="s3">#             }</span>
    <span class="s3">#         }</span>
    <span class="s3">#     ]</span>
    <span class="s3"># }</span>
    
    <span class="s3"># # response = {</span>
    <span class="s3"># #     'fulfillmentText': &quot; {} has generally {}\n It has {} which is {} &quot;.format(city, climate, pol, pol1)</span>
    <span class="s3"># # }</span>
    <span class="s3"># # response = {</span>
    <span class="s3"># #     &quot;outputContexts&quot;: [</span>
    <span class="s3"># #         {</span>
    <span class="s3"># #             &quot;name&quot;: &quot;Locationfollowon&quot;</span>
    <span class="s3"># #         }á¸¥</span>
    <span class="s3"># #     ]</span>
    <span class="s3"># # }</span>

    <span class="s3"># return response</span>


<span class="s0">def </span><span class="s1">bmi(height</span><span class="s0">, </span><span class="s1">weight):</span>
    <span class="s1">value = round(weight/((height/</span><span class="s4">100</span><span class="s1">)*(height/</span><span class="s4">100</span><span class="s1">))</span><span class="s0">,</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">value &gt;= </span><span class="s4">30.0</span><span class="s1">:</span>
        <span class="s1">status = </span><span class="s2">&quot;Obese&quot;</span>
        <span class="s1">remark = </span><span class="s2">&quot;You need to reduce a lot of weight as you have a very high risk of heart diseases&quot;</span>
    <span class="s0">elif </span><span class="s1">value &lt; </span><span class="s4">30.0 </span><span class="s0">and </span><span class="s1">value &gt;= </span><span class="s4">25.0</span><span class="s1">:</span>
        <span class="s1">status = </span><span class="s2">&quot;Overweight&quot;</span>
        <span class="s1">remark = </span><span class="s2">&quot;You need to look at your diet, exercise and reduce weight as you have high risk of diseases&quot;</span>
    <span class="s0">elif </span><span class="s1">value &lt; </span><span class="s4">25.0 </span><span class="s0">and </span><span class="s1">value &gt; </span><span class="s4">18.5</span><span class="s1">:</span>
        <span class="s1">status = </span><span class="s2">&quot;Healthy&quot;</span>
        <span class="s1">remark = </span><span class="s2">&quot;Keep up the good work. You are healthy and fit&quot;</span>
    <span class="s0">elif </span><span class="s1">value &lt; </span><span class="s4">18.5</span><span class="s1">:</span>
        <span class="s1">status = </span><span class="s2">&quot;Underweight&quot;</span>
        <span class="s1">remark = </span><span class="s2">&quot;Need to put on some weight as you are thin. Eat a healthy balanced diet&quot;</span>
    <span class="s1">text1 = </span><span class="s2">&quot;Your bmi is {} which comes under {} category.{}.&quot;</span><span class="s1">.format(value</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">remark)</span>
    <span class="s1">text2 = </span><span class="s2">&quot;Have you consumed nicotine or tobacco in last 3 years ?&quot;</span>
    <span class="s0">return </span><span class="s1">[text1</span><span class="s0">,</span><span class="s1">text2</span><span class="s0">,</span><span class="s1">[</span><span class="s2">&quot;Daily&quot;</span><span class="s0">,</span><span class="s2">&quot;Often&quot;</span><span class="s0">,</span><span class="s2">&quot;Occasionally&quot;</span><span class="s0">, </span><span class="s2">&quot;I do not consume&quot;</span><span class="s1">]]</span>
    <span class="s3"># Such a weird json response payload to type in. I think I am missing something? Better to make a class if time permits.</span>
    <span class="s3"># response = {</span>
    <span class="s3">#     'fulfillmentMessages': [</span>
    <span class="s3">#         {</span>
    <span class="s3">#             &quot;text&quot;: {</span>
    <span class="s3">#                 &quot;text&quot;: [</span>
    <span class="s3">#                     &quot;Your bmi is {} which comes under {} category.{}.&quot;.format(</span>
    <span class="s3">#                         value, status, remark)</span>
    <span class="s3">#                 ],</span>

    <span class="s3">#             }</span>
    <span class="s3">#         },</span>
    <span class="s3">#         {</span>
    <span class="s3">#             &quot;text&quot;: {</span>
    <span class="s3">#                 &quot;text&quot;: [</span>
    <span class="s3">#                     &quot;Have you consumed nicotine or tobacco in last 3 years ?&quot;</span>
    <span class="s3">#                 ]</span>
    <span class="s3">#             }</span>
    <span class="s3">#         },</span>
    <span class="s3">#         {</span>
    <span class="s3">#             'payload': {</span>
    <span class="s3">#                 &quot;richContent&quot;: [</span>
    <span class="s3">#                     [</span>
    <span class="s3">#                         {</span>
    <span class="s3">#                             &quot;type&quot;: &quot;chips&quot;,</span>
    <span class="s3">#                             &quot;options&quot;: [</span>
    <span class="s3">#                                 {</span>
    <span class="s3">#                                     &quot;text&quot;: &quot;Daily&quot;</span>
    <span class="s3">#                                 },</span>
    <span class="s3">#                                 {</span>
    <span class="s3">#                                     &quot;text&quot;: &quot;Often&quot;</span>
    <span class="s3">#                                 },</span>
    <span class="s3">#                                 {</span>
    <span class="s3">#                                     &quot;text&quot;: &quot;Occasionally&quot;</span>
    <span class="s3">#                                 },</span>
    <span class="s3">#                                 {</span>
    <span class="s3">#                                     &quot;text&quot;: &quot;I do not consume&quot;</span>
    <span class="s3">#                                 }</span>
    <span class="s3">#                             ]</span>

    <span class="s3">#                         }</span>
    <span class="s3">#                     ]</span>
    <span class="s3">#                 ]</span>

    <span class="s3">#             }</span>
    <span class="s3">#         }</span>
    <span class="s3">#     ]</span>
    <span class="s3"># }</span>

    <span class="s3"># return response</span>

<span class="s1">bmiintent = </span><span class="s2">&quot;Hi.Hi-no.Hi-no-Li-Sex-custom.Hi-no-LI-Sex-Age-custom.Hi-no-LI-Sex-Age-Ht-custom.Hi-no-LI-Sex-Age-Ht-Wt-custom&quot;</span>

<span class="s0">def </span><span class="s1">noLife(data1):</span>
    <span class="s1">act = data1.query_result.action</span>
    <span class="s0">if </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-no.Hi-no-Li-Sex-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Sex&quot;</span><span class="s1">] = data1.query_result.query_text</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-no.Hi-no-Li-Sex-custom.Hi-no-LI-Sex-Age-custom&quot;</span><span class="s1">:</span>
        <span class="s3">#print(&quot;Numbersa re&quot;, data1.query_result)</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Age&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
        <span class="s3">#print(dict1)</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-no.Hi-no-Li-Sex-custom.Hi-no-LI-Sex-Age-custom.Hi-no-LI-Sex-Age-Ht-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Height&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
        <span class="s3">#print(dict1)</span>
    <span class="s0">elif </span><span class="s1">act == bmiintent:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Weight&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
        <span class="s1">bmiresponse = bmi(float(dict1[</span><span class="s2">&quot;Height&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">float(dict1[</span><span class="s2">&quot;Weight&quot;</span><span class="s1">]))</span>
        <span class="s3">#dict1[&quot;bmi&quot;] = bmiresponse</span>
        <span class="s0">return </span><span class="s1">bmiresponse</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-no.Hi-no-Li-Sex-custom.Hi-no-LI-Sex-Age-custom.Hi-no-LI-Sex-Age-Ht-custom.Hi-no-LI-Sex-Age-Ht-Wt-custom.Hi-no-LI-Sex-Age-Ht-Wt-Nt-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Nicotine&quot;</span><span class="s1">] = data1.query_result.query_text</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-no.Hi-no-Li-Sex-custom.Hi-no-LI-Sex-Age-custom.Hi-no-LI-Sex-Age-Ht-custom.Hi-no-LI-Sex-Age-Ht-Wt-custom.Hi-no-LI-Sex-Age-Ht-Wt-Nt-custom.Hi-no-LI-Sex-Age-Ht-Wt-Nt-Inr-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Income&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-no.Hi-no-Li-Sex-custom.Hi-no-LI-Sex-Age-custom.Hi-no-LI-Sex-Age-Ht-custom.Hi-no-LI-Sex-Age-Ht-Wt-custom.Hi-no-LI-Sex-Age-Ht-Wt-Nt-custom.Hi-no-LI-Sex-Age-Ht-Wt-Nt-Inr-custom.Hi-no-LI-Sex-Age-Ht-Wt-Nt-Inr-Oc-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Occupation&quot;</span><span class="s1">] = data1.query_result.query_text</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;location&quot;</span><span class="s1">:</span>
        <span class="s1">city = data1.query_result.parameters[</span><span class="s2">&quot;geo-city&quot;</span><span class="s1">]</span>
        <span class="s1">print(</span><span class="s2">&quot;City is&quot;</span><span class="s0">, </span><span class="s1">city)</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Location&quot;</span><span class="s1">] = city</span>
        <span class="s1">a = geoDetails(city)</span>
        <span class="s0">return </span><span class="s1">a</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-no.Hi-no-Li-Sex-custom.Hi-no-LI-Sex-Age-custom.Hi-no-LI-Sex-Age-Ht-custom.Hi-no-LI-Sex-Age-Ht-Wt-custom.Hi-no-LI-Sex-Age-Ht-Wt-Nt-custom.Hi-no-LI-Sex-Age-Ht-Wt-Nt-Inr-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Income&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Investments.Investments-yes.Investments-yes-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Investments&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;loan&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Loan&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Investments.Investments-yes.Investments-yes-custom.Investments-yes-amt-custom.Investments-yes-amt-goals-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;RetrAge&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
        <span class="s1">sum_insured = sumInsured()</span>
        <span class="s0">return </span><span class="s1">sum_insured</span>
    <span class="s0">return </span><span class="s4">0</span>
    


<span class="s0">def </span><span class="s1">yesLife(data1):</span>
    <span class="s1">act = data1.query_result.action</span>
    <span class="s0">if </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-yes.Hi-yes-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Sex&quot;</span><span class="s1">] = data1.query_result.query_text</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-yes.Hi-yes-custom.Age-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Age&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-yes.Hi-yes-custom.Age-custom.Ret-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;RetrAge&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
        <span class="s1">planType = goalPlan(dict1[</span><span class="s2">&quot;Age&quot;</span><span class="s1">]</span><span class="s0">,</span><span class="s1">dict1[</span><span class="s2">&quot;RetrAge&quot;</span><span class="s1">])</span>
        <span class="s0">return </span><span class="s1">planType</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-yes.Hi-yes-custom.Age-custom.Ret-custom.Typ-custom.Nt-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Nicotine&quot;</span><span class="s1">] = data1.query_result.query_text</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-yes.Hi-yes-custom.Age-custom.Ret-custom.Typ-custom.Nt-custom.Rt-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Income&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-yes.Hi-yes-custom.Age-custom.Ret-custom.Typ-custom.Nt-custom.Rt-custom.Rp-yes&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;RetrResp&quot;</span><span class="s1">] = </span><span class="s2">&quot;Yes&quot;</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;LocAnn&quot;</span><span class="s1">:</span>
        <span class="s0">if </span><span class="s1">dict1[</span><span class="s2">&quot;RetrResp&quot;</span><span class="s1">] == </span><span class="s2">&quot;Yes&quot;</span><span class="s1">:</span>
            <span class="s1">dict1[</span><span class="s2">&quot;RetrAmt&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Loc-Ann.Loc-Ann-custom&quot;</span><span class="s1">:</span>
        <span class="s1">city = data1.query_result.parameters[</span><span class="s2">&quot;geo-city&quot;</span><span class="s1">]</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Location&quot;</span><span class="s1">] = city</span>
        <span class="s1">a = geoDetails(city)</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Loc-Ann.Loc-Ann-custom.Inv-no&quot;</span><span class="s1">:</span>
        <span class="s1">amt = annCalculation()</span>
        <span class="s0">return </span><span class="s1">amt</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;ILoc-Ann.Loc-Ann-custom.Inv-yes.Inv-yes-custom&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;Investments&quot;</span><span class="s1">] = data1.query_result.parameters[</span><span class="s2">&quot;number&quot;</span><span class="s1">]</span>
        <span class="s1">amt = annCalculation()</span>
        <span class="s0">return </span><span class="s1">amt</span>





<span class="s3"># @ app.route(&quot;/&quot;, methods=['POST'])</span>
<span class="s3"># def index():</span>
<span class="s3">#     data1 = request.get_json()</span>
<span class="s3">#     if &quot;initial&quot; in data1['queryResult']['action']:</span>
<span class="s3">#         pass</span>
<span class="s3">#     elif &quot;Hi.Hi-no&quot; == data1['queryResult']['action']:</span>
<span class="s3">#         dict1[&quot;Life Insurance&quot;] = &quot;No&quot;</span>
<span class="s3">#     elif &quot;Hi.Hi-yes&quot; == data1['queryResult']['action']:</span>
<span class="s3">#         dict1[&quot;Life Insurance&quot;] = &quot;Yes&quot;</span>
<span class="s3">#     elif &quot;Life Insurance&quot; in dict1.keys():</span>
<span class="s3">#         if dict1[&quot;Life Insurance&quot;] == &quot;No&quot;:</span>
<span class="s3">#             end, a = noLife(data1)</span>
<span class="s3">#             if end == &quot;end&quot;:</span>
<span class="s3">#                 return jsonify(a)</span>
<span class="s3">#         else:</span>
<span class="s3">#             yesLife()</span>
<span class="s3">#     response = {</span>
<span class="s3">#         'fulfillmentText': &quot;&quot;</span>
<span class="s3">#     }</span>
<span class="s3">#     return jsonify(response)</span>
<span class="s3">#&lt;link rel=&quot;stylesheet&quot; href=&quot;{{ url_for('static',  filename='css/template.css') }}&quot;&gt;</span>

<span class="s1">@ app.route(</span><span class="s2">&quot;/welcome&quot;</span><span class="s0">, </span><span class="s1">methods=[</span><span class="s2">'POST'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">welcome():</span>
    <span class="s1">message = {}</span>
    <span class="s1">richresponses = apicode.welcome_text()</span>
    <span class="s1">i = </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">messageresp </span><span class="s0">in </span><span class="s1">richresponses:</span>
        <span class="s3">#print(i,messageresp.text.text[0])</span>
        <span class="s1">message[</span><span class="s2">&quot;answer&quot;</span><span class="s1">+str(i)] = messageresp.text.text[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">i = i+</span><span class="s4">1</span>
    <span class="s0">return </span><span class="s1">jsonify(message)</span>

<span class="s3">#query_text and parameters</span>
<span class="s3"># https://googleapis.dev/python/dialogflow/latest/dialogflow_v2/types.html?highlight=query#google.cloud.dialogflow_v2.types.QueryResult</span>

<span class="s1">@ app.route(</span><span class="s2">&quot;/predict&quot;</span><span class="s0">, </span><span class="s1">methods=[</span><span class="s2">&quot;POST&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">predict():</span>
    <span class="s1">message = {}</span>
    <span class="s3">#print(&quot;This is the object&quot;, request.get_json())</span>
    <span class="s1">text = request.get_json().get(</span><span class="s2">&quot;message&quot;</span><span class="s1">)</span>
    <span class="s1">resp = apicode.detect_intent_texts(</span><span class="s2">&quot;nova-dskj&quot;</span><span class="s0">,</span><span class="s2">&quot;1234&quot;</span><span class="s0">,</span><span class="s1">text)</span>
    
    
    <span class="s1">richresponses = resp.query_result.fulfillment_messages</span>
    <span class="s3"># print(&quot;=&quot; *20)</span>
    <span class="s3">#msg.payload[&quot;richContent&quot;][0][0][&quot;options&quot;][i][&quot;text&quot;]</span>
    
    <span class="s3">#print(len(msg.payload[&quot;richContent&quot;][0][0][&quot;options&quot;]))</span>
    <span class="s3">#print([len(msg.payload[&quot;richContent&quot;][0][0][&quot;options&quot;]) for msg in richresponses if msg.payload])</span>
    <span class="s3"># print(&quot;=&quot; *20)</span>

    <span class="s3"># GOD please help me on how to deserialise a Struct protubuf by google. This is a hacky solution until then :(</span>
    <span class="s1">act = resp.query_result.action</span>
    <span class="s0">if </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-no&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;type&quot;</span><span class="s1">] = </span><span class="s2">&quot;Life Insurance&quot;</span>
    <span class="s0">elif </span><span class="s1">act == </span><span class="s2">&quot;Hi.Hi-yes&quot;</span><span class="s1">:</span>
        <span class="s1">dict1[</span><span class="s2">&quot;type&quot;</span><span class="s1">] = </span><span class="s2">&quot;Annuity&quot;</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">pass</span>

    <span class="s0">if </span><span class="s1">dict1[</span><span class="s2">&quot;type&quot;</span><span class="s1">] == </span><span class="s2">&quot;Life Insurance&quot;</span><span class="s1">:</span>
        <span class="s1">funcot = noLife(resp)</span>
        <span class="s0">if </span><span class="s1">funcot:</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s0">,</span><span class="s1">text </span><span class="s0">in </span><span class="s1">enumerate(funcot):</span>
                <span class="s1">message[</span><span class="s2">&quot;answer&quot;</span><span class="s1">+str(i)] = funcot[i]</span>
                <span class="s0">if </span><span class="s1">i==</span><span class="s4">1</span><span class="s1">:</span>
                    <span class="s0">break</span>

            <span class="s0">if </span><span class="s1">len(funcot)&gt;</span><span class="s4">2</span><span class="s1">:</span>
                <span class="s0">for </span><span class="s1">i</span><span class="s0">,</span><span class="s1">text </span><span class="s0">in </span><span class="s1">enumerate(funcot[</span><span class="s4">2</span><span class="s1">]):</span>
                    <span class="s1">message[</span><span class="s2">&quot;chips&quot;</span><span class="s1">+str(i)] = funcot[</span><span class="s4">2</span><span class="s1">][i]</span>
            <span class="s0">return </span><span class="s1">jsonify(message)</span>

    <span class="s0">elif </span><span class="s1">dict1[</span><span class="s2">&quot;type&quot;</span><span class="s1">] == </span><span class="s2">&quot;Annuity&quot;</span><span class="s1">:</span>
        <span class="s1">funcot = yesLife(resp)</span>
        <span class="s0">if </span><span class="s1">funcot:</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">text </span><span class="s0">in </span><span class="s1">enumerate(funcot):</span>
                <span class="s1">message[</span><span class="s2">&quot;answer&quot; </span><span class="s1">+ str(i)] = funcot[i]</span>
                <span class="s0">if </span><span class="s1">i == </span><span class="s4">1</span><span class="s1">:</span>
                    <span class="s0">break</span>

            <span class="s0">if </span><span class="s1">len(funcot) &gt; </span><span class="s4">2</span><span class="s1">:</span>
                <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">text </span><span class="s0">in </span><span class="s1">enumerate(funcot[</span><span class="s4">2</span><span class="s1">]):</span>
                    <span class="s1">message[</span><span class="s2">&quot;chips&quot; </span><span class="s1">+ str(i)] = funcot[</span><span class="s4">2</span><span class="s1">][i]</span>
            <span class="s0">return </span><span class="s1">jsonify(message)</span>

    <span class="s1">i = </span><span class="s4">0</span>

    <span class="s3"># GOD please help me on how to deserialise a Struct protubuf by google. This is a hacky solution until then :(</span>
    <span class="s0">for </span><span class="s1">messageresp </span><span class="s0">in </span><span class="s1">richresponses:</span>
        <span class="s0">if </span><span class="s1">messageresp.payload:</span>
            <span class="s3"># templist = []</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(len(messageresp.payload[</span><span class="s2">&quot;richContent&quot;</span><span class="s1">][</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">][</span><span class="s2">&quot;options&quot;</span><span class="s1">]) ):</span>
                <span class="s3">#templist.append(messageresp.payload[&quot;richContent&quot;][0][0][&quot;options&quot;][j][&quot;text&quot;])</span>
                <span class="s1">message[</span><span class="s2">&quot;chips&quot;</span><span class="s1">+str(j)] = messageresp.payload[</span><span class="s2">&quot;richContent&quot;</span><span class="s1">][</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">][</span><span class="s2">&quot;options&quot;</span><span class="s1">][j][</span><span class="s2">&quot;text&quot;</span><span class="s1">]</span>

        <span class="s0">if </span><span class="s1">messageresp.text:</span>
            <span class="s1">message[</span><span class="s2">&quot;answer&quot;</span><span class="s1">+str(i)] = messageresp.text.text[</span><span class="s4">0</span><span class="s1">]</span>
            <span class="s1">i = i+</span><span class="s4">1</span>
    
    <span class="s0">return </span><span class="s1">jsonify(message)</span>

<span class="s1">@ app.route(</span><span class="s2">&quot;/&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">website():</span>
    <span class="s0">return </span><span class="s1">render_template(</span><span class="s2">&quot;base.html&quot;</span><span class="s1">)</span>


<span class="s0">if </span><span class="s1">__name__ == </span><span class="s2">&quot;__main__&quot;</span><span class="s1">:</span>
    <span class="s1">app.run(debug=</span><span class="s0">True</span><span class="s1">)</span>
</pre>
</body>
</html>